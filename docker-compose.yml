services:
  # VictoriaMetrics - Time-series database
  victoria-metrics:
    image: victoriametrics/victoria-metrics:v1.129.1
    container_name: xrpl-monitor-victoria
    ports:
      - "${VICTORIA_METRICS_PORT:-8428}:8428"
    volumes:
      - victoria_data:/victoria-metrics-data
    command:
      - '--storageDataPath=/victoria-metrics-data'
      - '--retentionPeriod=365d'
      - '--httpListenAddr=:8428'
      # State backup retention: VictoriaMetrics single-node does not support per-metric
      # retention filters. State backups follow the main retentionPeriod (365d).
      # Storage impact is negligible: ~4 MB/year for 5 backup metrics.
      # Memory optimization flags - OPTIMIZED DEFAULTS (DO NOT CHANGE)
      # These settings have been tuned for exceptional performance:
      # - 98.6% cache hit rate (measured in production)
      # - 88% CPU reduction compared to baseline
      # - 5ms average query response time
      # See docs/PERFORMANCE_REPORT.md for detailed analysis
      - '--memory.allowedBytes=512MB'
      - '--search.maxMemoryPerQuery=100MB'
      - '--storage.cacheSizeIndexDBIndexBlocks=64MB'
      - '--storage.cacheSizeIndexDBDataBlocks=64MB'
      - '--storage.cacheSizeStorageTSID=64MB'
    restart: unless-stopped
    networks:
      - xrpl-monitor-network

  # Grafana OSS - Dashboards and visualization
  # Note: Login page branding requires building Grafana from source or paid Enterprise license.
  # Email alerts use custom templates with XRPL Monitor logo (only customization that works).
  grafana:
    image: grafana/grafana:latest
    container_name: xrpl-monitor-grafana
    volumes:
      - grafana_data:/var/lib/grafana
      # Mount entire provisioning directory (datasources, dashboards, alerting)
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
      # Custom email templates (replaces Grafana logo with XRPL Monitor logo)
      - ./config/grafana/emails:/usr/share/grafana/public/emails:ro
    environment:
      - GF_SERVER_HTTP_PORT=${GRAFANA_PORT:-3000}
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_DASHBOARDS_MIN_REFRESH_INTERVAL=1s
      - GF_INSTALL_PLUGINS=
      # Note: Home dashboard is set via API after import (not env var) to avoid
      # "Save as copy" limitation. See install.sh set_home_dashboard function.
      # SMTP for email alerts (configure in .env file)
      - GF_SMTP_ENABLED=${GF_SMTP_ENABLED:-false}
      - GF_SMTP_HOST=${GF_SMTP_HOST:-}
      - GF_SMTP_USER=${GF_SMTP_USER:-}
      - GF_SMTP_PASSWORD=${GF_SMTP_PASSWORD:-}
      - GF_SMTP_FROM_ADDRESS=${GF_SMTP_FROM_ADDRESS:-}
    restart: unless-stopped
    depends_on:
      - victoria-metrics
    network_mode: "host"
    cpus: "2.0"
    mem_limit: "1g"

  # Node Exporter - System metrics collector
  node-exporter:
    image: prom/node-exporter:v1.10.2
    container_name: xrpl-monitor-node-exporter
    hostname: xrpl-validator
    network_mode: "host"
    command:
      - '--path.rootfs=/host'
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
      - '--web.listen-address=:${NODE_EXPORTER_PORT:-9100}'
    volumes:
      - /:/host:ro,rslave
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
    restart: unless-stopped
    cpus: "0.2"
    mem_limit: "128m"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:${NODE_EXPORTER_PORT:-9100}/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Uptime Exporter - rippled uptime metrics
  uptime-exporter:
    image: xrpl-validator-dashboard
    build:
      context: .
      dockerfile: Dockerfile
    container_name: xrpl-monitor-uptime-exporter
    command: ["python", "-m", "src.exporters.uptime_exporter"]
    environment:
      - XRPL_WS_URL=${RIPPLED_WS_URL:-ws://localhost:6006}
      - SCRAPE_INTERVAL=5
      - EXPORTER_PORT=${UPTIME_EXPORTER_PORT:-9101}
      - INSTANCE_LABEL=validator
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    restart: unless-stopped
    network_mode: "host"
    cpus: "0.1"
    mem_limit: "256m"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${UPTIME_EXPORTER_PORT:-9101}/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # State Exporter - Real-time rippled state metrics (bypasses VictoriaMetrics)
  state-exporter:
    image: xrpl-validator-dashboard
    build:
      context: .
      dockerfile: Dockerfile
    container_name: xrpl-monitor-state-exporter
    command: ["python", "-m", "src.exporters.state_exporter"]
    environment:
      - XRPL_HTTP_URL=${RIPPLED_HTTP_URL:-http://localhost:5005}
      - POLL_INTERVAL=1
      - EXPORTER_PORT=${STATE_EXPORTER_PORT:-9102}
      - INSTANCE_LABEL=validator
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    restart: unless-stopped
    network_mode: "host"
    cpus: "0.1"
    mem_limit: "128m"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${STATE_EXPORTER_PORT:-9102}/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # vmagent - Scrapes node-exporter and pushes to VictoriaMetrics
  vmagent:
    image: victoriametrics/vmagent:v1.129.1
    container_name: xrpl-monitor-vmagent
    volumes:
      - ./config/vmagent:/etc/vmagent:ro
      - vmagent_data:/vmagentdata
    command:
      - '-promscrape.config=/etc/vmagent/scrape.yml'
      - '-remoteWrite.url=http://localhost:${VICTORIA_METRICS_PORT:-8428}/api/v1/write'
      - '-httpListenAddr=:${VMAGENT_PORT:-8427}'
    restart: unless-stopped
    depends_on:
      - victoria-metrics
      - node-exporter
      - uptime-exporter
      - state-exporter
    network_mode: "host"

  # Autoheal - Automatically restart unhealthy containers
  autoheal:
    image: willfarrell/autoheal:latest
    container_name: xrpl-monitor-autoheal
    restart: unless-stopped
    environment:
      - AUTOHEAL_CONTAINER_LABEL=all
      - AUTOHEAL_INTERVAL=10  # Check every 10 seconds
      - AUTOHEAL_START_PERIOD=30  # Wait 30s before first check
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - xrpl-monitor-network

  # Collector - Python metrics collection application
  collector:
    image: xrpl-validator-dashboard
    build:
      context: .
      dockerfile: Dockerfile
    container_name: xrpl-monitor-collector
    volumes:
      # Docker socket for docker exec fallback (peer metrics)
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # rippled data directory for NuDB metrics (adjust path for your setup)
      # For Docker rippled: mount host path where rippled stores data
      # For native rippled: mount /var/lib/rippled
      - ${RIPPLED_DATA_PATH:-/var/lib/rippled}:/rippled-data:ro
      # Host /proc for CPU monitoring of native rippled processes
      - /proc:/host/proc:ro
      # Logs directory
      - ./logs:/app/logs
      # State directory for persistent counters and gauges
      - collector_state:/app/state
    environment:
      # Load from .env file
      - RIPPLED_WS_URL=${RIPPLED_WS_URL:-ws://localhost:6006}
      - RIPPLED_HTTP_URL=${RIPPLED_HTTP_URL:-http://localhost:5005}
      - VICTORIA_METRICS_URL=http://localhost:${VICTORIA_METRICS_PORT:-8428}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - VALIDATOR_PUBLIC_KEY=${VALIDATOR_PUBLIC_KEY}
      - RIPPLED_DOCKER_CONTAINER=${RIPPLED_DOCKER_CONTAINER}
      # For Docker mount, tell collector where rippled data is mounted in container
      - RIPPLED_DATA_PATH=/rippled-data
      - COLLECTOR_PORT=${COLLECTOR_PORT:-8090}
    restart: unless-stopped
    depends_on:
      - victoria-metrics
    # Use host network for easy access to rippled (native or Docker on localhost)
    network_mode: "host"
    # Grant access to Docker socket (required for docker exec)
    # Note: User must be in docker group on host (GID usually 999)
    group_add:
      - ${DOCKER_GID:-999}
    # Health check: Verify WebSocket connection is healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${COLLECTOR_PORT:-8090}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  victoria_data:
    name: xrpl-monitor-victoria-data
  grafana_data:
    name: xrpl-monitor-grafana-data
  vmagent_data:
    name: xrpl-monitor-vmagent-data
  collector_state:
    name: xrpl-monitor-collector-state

networks:
  xrpl-monitor-network:
    name: xrpl-monitor-network
